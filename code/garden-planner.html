<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garden Planner - Crop Rotation & Companion Planting</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Playfair+Display:wght@600;700&display=swap');
        
        :root {
            --soil-dark: #3a2f28;
            --soil-medium: #5d4e3f;
            --leaf-green: #4a7c59;
            --sage: #8ba888;
            --cream: #f4f1ea;
            --terracotta: #c1694f;
            --sun-yellow: #e8b84d;
            --root-brown: #6b4423;
            --water-blue: #7ba8a8;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Merriweather', serif;
            background: var(--cream);
            color: var(--soil-dark);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(138, 168, 136, 0.03), transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(193, 105, 79, 0.02), transparent 40%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }
        
        header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
            border-bottom: 2px solid var(--leaf-green);
            position: relative;
        }
        
        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 3.5rem;
            color: var(--leaf-green);
            font-weight: 700;
            letter-spacing: -1px;
            margin-bottom: 0.5rem;
            animation: slideDown 0.8s ease-out;
        }
        
        .subtitle {
            font-size: 1.1rem;
            color: var(--soil-medium);
            font-weight: 300;
            font-style: italic;
            animation: fadeIn 1s ease-out 0.3s both;
        }
        
        .data-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            animation: fadeIn 1s ease-out 0.5s both;
        }
        
        .panel {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(58, 47, 40, 0.08);
            border: 1px solid rgba(74, 124, 89, 0.1);
        }
        
        .panel h2 {
            font-family: 'Playfair Display', serif;
            color: var(--leaf-green);
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--sage);
            padding-bottom: 0.5rem;
        }
        
        .year-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1rem;
            background: linear-gradient(135deg, var(--sage) 0%, var(--leaf-green) 100%);
            border-radius: 8px;
            color: white;
        }
        
        .year-selector button {
            background: white;
            color: var(--leaf-green);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .year-selector button:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .year-display {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 700;
            flex: 1;
            text-align: center;
        }
        
        .wishlist-section {
            margin-bottom: 2rem;
        }
        
        .wishlist-input {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        select, input, button {
            font-family: 'Merriweather', serif;
            font-size: 1rem;
        }
        
        select, input[type="text"], input[type="number"] {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid var(--sage);
            border-radius: 6px;
            background: var(--cream);
            color: var(--soil-dark);
            transition: all 0.3s ease;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--leaf-green);
            background: white;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background: var(--leaf-green);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--soil-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 124, 89, 0.3);
        }
        
        .btn-secondary {
            background: var(--terracotta);
            color: white;
        }
        
        .btn-secondary:hover {
            background: var(--root-brown);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(193, 105, 79, 0.3);
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }
        
        .btn-suggest {
            width: 100%;
            background: linear-gradient(135deg, var(--sun-yellow) 0%, var(--terracotta) 100%);
            color: var(--soil-dark);
            font-size: 1.1rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .btn-suggest:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(232, 184, 77, 0.4);
        }
        
        .wishlist-items {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .wishlist-tag {
            background: var(--sage);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            animation: popIn 0.3s ease-out;
        }
        
        @keyframes popIn {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .wishlist-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .wishlist-tag button:hover {
            transform: scale(1.2);
        }
        
        .garden-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .bed {
            background: linear-gradient(135deg, #f8f5ee 0%, #ebe6da 100%);
            border: 3px solid var(--soil-medium);
            border-radius: 10px;
            padding: 1.5rem;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .bed:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(58, 47, 40, 0.15);
        }
        
        .bed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--sage);
        }
        
        .bed-name {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            color: var(--leaf-green);
            font-weight: 700;
        }
        
        .bed-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .bed-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem;
            transition: transform 0.2s ease;
        }
        
        .bed-actions button:hover {
            transform: scale(1.2);
        }
        
        .bed-content {
            min-height: 100px;
        }
        
        .plant-assignment {
            background: white;
            border-left: 4px solid var(--leaf-green);
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .plant-assignment:hover {
            background: var(--cream);
            border-left-width: 6px;
        }
        
        .plant-name {
            font-weight: 700;
            color: var(--leaf-green);
            margin-bottom: 0.25rem;
        }
        
        .plant-meta {
            font-size: 0.85rem;
            color: var(--soil-medium);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .nutrition-badge {
            padding: 0.15rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .nutrition-high {
            background: var(--terracotta);
            color: white;
        }
        
        .nutrition-medium {
            background: var(--sun-yellow);
            color: var(--soil-dark);
        }
        
        .nutrition-low {
            background: var(--sage);
            color: white;
        }
        
        .empty-bed {
            color: var(--soil-medium);
            font-style: italic;
            text-align: center;
            padding: 2rem 0;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(58, 47, 40, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--sage);
        }
        
        .modal-header h3 {
            font-family: 'Playfair Display', serif;
            color: var(--leaf-green);
            font-size: 1.8rem;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--soil-medium);
            line-height: 1;
        }
        
        .close-btn:hover {
            color: var(--terracotta);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--soil-dark);
        }
        
        .companions-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .companion-tag {
            padding: 0.4rem 0.8rem;
            border-radius: 16px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .companion-good {
            background: #d4edda;
            color: #155724;
        }
        
        .companion-bad {
            background: #f8d7da;
            color: #721c24;
        }
        
        .suggestion-box {
            background: linear-gradient(135deg, #fff8e1 0%, #ffe7b8 100%);
            border: 2px solid var(--sun-yellow);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .suggestion-box h4 {
            font-family: 'Playfair Display', serif;
            color: var(--root-brown);
            margin-bottom: 1rem;
        }
        
        .suggestion-item {
            background: white;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 6px;
            border-left: 4px solid var(--sun-yellow);
        }
        
        .suggestion-item strong {
            color: var(--leaf-green);
        }
        
        .info-text {
            background: var(--cream);
            padding: 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            color: var(--soil-medium);
            margin-bottom: 1rem;
            border-left: 3px solid var(--water-blue);
        }
        
        .compatibility-matrix {
            overflow-x: auto;
            margin-top: 1rem;
        }
        
        .compatibility-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .compatibility-table th,
        .compatibility-table td {
            padding: 0.5rem;
            text-align: center;
            border: 1px solid var(--sage);
        }
        
        .compatibility-table th {
            background: var(--leaf-green);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .compatibility-table tr:hover {
            background: var(--cream);
        }
        
        .compat-good {
            background: #d4edda;
            color: #155724;
        }
        
        .compat-bad {
            background: #f8d7da;
            color: #721c24;
        }
        
        .compat-neutral {
            background: #f8f9fa;
        }
        
        .tab-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--sage);
        }
        
        .tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--soil-medium);
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab:hover {
            color: var(--leaf-green);
        }
        
        .tab.active {
            color: var(--leaf-green);
            border-bottom-color: var(--leaf-green);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2.5rem;
            }
            
            .garden-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üå± Garden Planner</h1>
            <p class="subtitle">Crop Rotation & Companion Planting Made Simple</p>
            <div class="data-controls">
                <button class="btn btn-secondary btn-small" onclick="app.exportData()">üíæ Export Data</button>
                <button class="btn btn-secondary btn-small" onclick="app.importData()">üìÇ Import Data</button>
                <button class="btn btn-primary btn-small" onclick="app.showCompatibilityMatrix()">üìä View Matrix</button>
            </div>
        </header>
        
        <div class="main-grid">
            <!-- Left Panel: Controls -->
            <div>
                <div class="panel">
                    <h2>Planning Controls</h2>
                    
                    <div class="year-selector">
                        <button onclick="app.changeYear(-1)">‚Üê</button>
                        <div class="year-display" id="yearDisplay">2024</div>
                        <button onclick="app.changeYear(1)">‚Üí</button>
                    </div>
                    
                    <div class="wishlist-section">
                        <h3 style="margin-bottom: 1rem; color: var(--soil-dark);">Your Wishlist</h3>
                        <div class="wishlist-input">
                            <select id="vegetableSelect">
                                <option value="">Select vegetable...</option>
                            </select>
                            <button class="btn btn-primary" onclick="app.addToWishlist()">Add</button>
                        </div>
                        <div class="wishlist-items" id="wishlistItems"></div>
                        
                        <button class="btn btn-suggest" onclick="app.generateSuggestions()">
                            ‚ú® Suggest Garden Plan
                        </button>
                        
                        <div id="suggestionsBox"></div>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <button class="btn btn-secondary" style="width: 100%;" onclick="app.addBed()">
                            + Add Garden Bed
                        </button>
                    </div>
                    
                    <div class="info-text" style="margin-top: 2rem;">
                        <strong>üí° How it works:</strong><br>
                        Add vegetables to your wishlist, then click "Suggest Garden Plan" to get optimal bed assignments based on crop rotation and companion planting rules.
                    </div>
                </div>
            </div>
            
            <!-- Right Panel: Garden Beds -->
            <div class="panel">
                <h2>Garden Beds - <span id="yearDisplayBeds">2024</span></h2>
                <div class="garden-grid" id="gardenGrid"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal for Bed Assignment -->
    <div class="modal" id="bedModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Assign Plants</h3>
                <button class="close-btn" onclick="app.closeModal()">√ó</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>
    
    <!-- Modal for Compatibility Matrix -->
    <div class="modal" id="matrixModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>Companion Planting Matrix</h3>
                <button class="close-btn" onclick="app.closeMatrixModal()">√ó</button>
            </div>
            <div id="matrixBody"></div>
        </div>
    </div>
    
    <script>
        // ============================================
        // CORE CLASS HIERARCHY
        // ============================================
        
        /**
         * Base class for vegetable information
         */
        class Vegetable {
            constructor(id, name, nutrition, family) {
                this.id = id;
                this.name = name;
                this.nutrition = nutrition; // 'high', 'medium', 'low'
                this.family = family;
                this.goodCompanions = [];
                this.badCompanions = [];
            }
            
            addGoodCompanion(vegetableId) {
                if (!this.goodCompanions.includes(vegetableId)) {
                    this.goodCompanions.push(vegetableId);
                }
            }
            
            addBadCompanion(vegetableId) {
                if (!this.badCompanions.includes(vegetableId)) {
                    this.badCompanions.push(vegetableId);
                }
            }
            
            isCompatibleWith(vegetableId) {
                if (this.badCompanions.includes(vegetableId)) return -1;
                if (this.goodCompanions.includes(vegetableId)) return 1;
                return 0;
            }
            
            toJSON() {
                return {
                    id: this.id,
                    name: this.name,
                    nutrition: this.nutrition,
                    family: this.family,
                    goodCompanions: this.goodCompanions,
                    badCompanions: this.badCompanions
                };
            }
            
            static fromJSON(data) {
                const veg = new Vegetable(data.id, data.name, data.nutrition, data.family);
                veg.goodCompanions = data.goodCompanions || [];
                veg.badCompanions = data.badCompanions || [];
                return veg;
            }
        }
        
        /**
         * Represents a planting in a specific bed and year
         */
        class Planting {
            constructor(bedId, year, vegetableId) {
                this.bedId = bedId;
                this.year = year;
                this.vegetableId = vegetableId;
            }
            
            toJSON() {
                return {
                    bedId: this.bedId,
                    year: this.year,
                    vegetableId: this.vegetableId
                };
            }
            
            static fromJSON(data) {
                return new Planting(data.bedId, data.year, data.vegetableId);
            }
        }
        
        /**
         * Represents a garden bed
         */
        class GardenBed {
            constructor(id, name) {
                this.id = id;
                this.name = name;
            }
            
            toJSON() {
                return {
                    id: this.id,
                    name: this.name
                };
            }
            
            static fromJSON(data) {
                return new GardenBed(data.id, data.name);
            }
        }
        
        /**
         * Manages the entire garden with all its data
         */
        class GardenManager {
            constructor() {
                this.vegetables = new Map();
                this.beds = new Map();
                this.plantings = [];
                this.initializeVegetableDatabase();
            }
            
            initializeVegetableDatabase() {
                // Initialize vegetables
                const veggies = [
                    new Vegetable('tomato', 'Tomato', 'high', 'Solanaceae'),
                    new Vegetable('potato', 'Potato', 'high', 'Solanaceae'),
                    new Vegetable('carrot', 'Carrot', 'low', 'Apiaceae'),
                    new Vegetable('lettuce', 'Lettuce', 'low', 'Asteraceae'),
                    new Vegetable('cabbage', 'Cabbage', 'high', 'Brassicaceae'),
                    new Vegetable('beans', 'Beans', 'low', 'Fabaceae'),
                    new Vegetable('peas', 'Peas', 'low', 'Fabaceae'),
                    new Vegetable('onion', 'Onion', 'medium', 'Amaryllidaceae'),
                    new Vegetable('garlic', 'Garlic', 'medium', 'Amaryllidaceae'),
                    new Vegetable('cucumber', 'Cucumber', 'medium', 'Cucurbitaceae'),
                    new Vegetable('zucchini', 'Zucchini', 'medium', 'Cucurbitaceae'),
                    new Vegetable('corn', 'Corn', 'high', 'Poaceae'),
                    new Vegetable('radish', 'Radish', 'low', 'Brassicaceae'),
                    new Vegetable('spinach', 'Spinach', 'medium', 'Amaranthaceae'),
                    new Vegetable('basil', 'Basil', 'low', 'Lamiaceae'),
                    new Vegetable('pepper', 'Pepper', 'medium', 'Solanaceae'),
                ];
                
                veggies.forEach(v => this.vegetables.set(v.id, v));
                
                // Set up companion planting relationships
                this.setCompanions('tomato', ['basil', 'carrot', 'lettuce'], ['potato', 'cabbage']);
                this.setCompanions('potato', ['beans', 'corn'], ['tomato', 'cucumber']);
                this.setCompanions('carrot', ['tomato', 'lettuce', 'onion'], ['dill']);
                this.setCompanions('lettuce', ['carrot', 'radish'], []);
                this.setCompanions('cabbage', ['beans', 'potato'], ['tomato']);
                this.setCompanions('beans', ['corn', 'cabbage', 'potato'], ['onion', 'garlic']);
                this.setCompanions('peas', ['carrot', 'radish'], ['onion', 'garlic']);
                this.setCompanions('onion', ['carrot', 'lettuce', 'tomato'], ['beans', 'peas']);
                this.setCompanions('garlic', ['tomato', 'cabbage'], ['beans', 'peas']);
                this.setCompanions('cucumber', ['beans', 'corn', 'peas'], ['potato']);
                this.setCompanions('zucchini', ['beans', 'corn'], ['potato']);
                this.setCompanions('corn', ['beans', 'cucumber', 'peas'], ['tomato']);
                this.setCompanions('radish', ['lettuce', 'peas', 'carrot'], []);
                this.setCompanions('spinach', ['peas'], []);
                this.setCompanions('basil', ['tomato', 'pepper'], []);
                this.setCompanions('pepper', ['basil', 'onion'], ['beans']);
            }
            
            setCompanions(vegId, good, bad) {
                const veg = this.vegetables.get(vegId);
                if (!veg) return;
                
                good.forEach(g => {
                    if (this.vegetables.has(g)) {
                        veg.addGoodCompanion(g);
                    }
                });
                
                bad.forEach(b => {
                    if (this.vegetables.has(b)) {
                        veg.addBadCompanion(b);
                    }
                });
            }
            
            addBed(name) {
                const id = Date.now();
                const bed = new GardenBed(id, name || `Bed ${this.beds.size + 1}`);
                this.beds.set(id, bed);
                return bed;
            }
            
            removeBed(bedId) {
                this.beds.delete(bedId);
                this.plantings = this.plantings.filter(p => p.bedId !== bedId);
            }
            
            addPlanting(bedId, year, vegetableId) {
                // Remove existing planting for this bed/year/vegetable combo
                this.plantings = this.plantings.filter(
                    p => !(p.bedId === bedId && p.year === year && p.vegetableId === vegetableId)
                );
                this.plantings.push(new Planting(bedId, year, vegetableId));
            }
            
            removePlanting(bedId, year, vegetableId) {
                this.plantings = this.plantings.filter(
                    p => !(p.bedId === bedId && p.year === year && p.vegetableId === vegetableId)
                );
            }
            
            getPlantingsForBed(bedId, year) {
                return this.plantings
                    .filter(p => p.bedId === bedId && p.year === year)
                    .map(p => this.vegetables.get(p.vegetableId))
                    .filter(v => v);
            }
            
            getPlantingIdsForBed(bedId, year) {
                return this.plantings
                    .filter(p => p.bedId === bedId && p.year === year)
                    .map(p => p.vegetableId);
            }
            
            // Export/Import functionality
            exportData() {
                return JSON.stringify({
                    vegetables: Array.from(this.vegetables.values()).map(v => v.toJSON()),
                    beds: Array.from(this.beds.values()).map(b => b.toJSON()),
                    plantings: this.plantings.map(p => p.toJSON())
                }, null, 2);
            }
            
            importData(jsonString) {
                try {
                    const data = JSON.parse(jsonString);
                    
                    // Import vegetables
                    this.vegetables.clear();
                    data.vegetables.forEach(v => {
                        const veg = Vegetable.fromJSON(v);
                        this.vegetables.set(veg.id, veg);
                    });
                    
                    // Import beds
                    this.beds.clear();
                    data.beds.forEach(b => {
                        const bed = GardenBed.fromJSON(b);
                        this.beds.set(bed.id, bed);
                    });
                    
                    // Import plantings
                    this.plantings = data.plantings.map(p => Planting.fromJSON(p));
                    
                    return true;
                } catch (e) {
                    console.error('Import failed:', e);
                    return false;
                }
            }
            
            // Save to localStorage
            saveToLocalStorage() {
                localStorage.setItem('gardenPlannerData', this.exportData());
            }
            
            // Load from localStorage
            loadFromLocalStorage() {
                const data = localStorage.getItem('gardenPlannerData');
                if (data) {
                    return this.importData(data);
                }
                return false;
            }
        }
        
        // ============================================
        // SUGGESTION ALGORITHM
        // ============================================
        
        class SuggestionEngine {
            constructor(gardenManager) {
                this.garden = gardenManager;
            }
            
            /**
             * Generate optimal bed assignments based on wishlist
             */
            generateSuggestions(wishlist, currentYear) {
                const suggestions = [];
                const beds = Array.from(this.garden.beds.values());
                const usedVeggies = new Set();
                
                // Score each bed for each vegetable
                const bedScores = [];
                
                for (const bed of beds) {
                    for (const vegId of wishlist) {
                        if (usedVeggies.has(vegId)) continue;
                        
                        const score = this.scorePlantingOption(bed.id, vegId, currentYear);
                        bedScores.push({
                            bedId: bed.id,
                            bedName: bed.name,
                            vegId: vegId,
                            score: score.total,
                            reasons: score.reasons
                        });
                    }
                }
                
                // Sort by score (highest first)
                bedScores.sort((a, b) => b.score - a.score);
                
                // Assign vegetables to beds
                const assignedBeds = new Set();
                
                for (const option of bedScores) {
                    if (usedVeggies.has(option.vegId) || assignedBeds.has(option.bedId)) {
                        continue;
                    }
                    
                    suggestions.push({
                        bedId: option.bedId,
                        bedName: option.bedName,
                        vegId: option.vegId,
                        vegetableName: this.garden.vegetables.get(option.vegId).name,
                        score: option.score,
                        reasons: option.reasons
                    });
                    
                    usedVeggies.add(option.vegId);
                    assignedBeds.add(option.bedId);
                }
                
                return suggestions;
            }
            
            /**
             * Score a planting option based on multiple criteria
             */
            scorePlantingOption(bedId, vegId, year) {
                const veg = this.garden.vegetables.get(vegId);
                if (!veg) return { total: 0, reasons: [] };
                
                let score = 0;
                const reasons = [];
                
                // Get previous year's plantings
                const prevYear = this.garden.getPlantingIdsForBed(bedId, year - 1);
                const currentYear = this.garden.getPlantingIdsForBed(bedId, year);
                
                // Rule 1: Family rotation (avoid same family)
                const prevFamilies = prevYear.map(id => this.garden.vegetables.get(id)?.family).filter(f => f);
                if (!prevFamilies.includes(veg.family)) {
                    score += 30;
                    reasons.push('Different plant family from previous year');
                } else {
                    score -= 20;
                    reasons.push('‚ö†Ô∏è Same plant family as previous year');
                }
                
                // Rule 2: Nutrition rotation
                const prevNutrition = prevYear.map(id => this.garden.vegetables.get(id)?.nutrition).filter(n => n);
                if (prevNutrition.includes('high') && veg.nutrition === 'low') {
                    score += 25;
                    reasons.push('Restores soil nutrients after heavy feeder');
                } else if (prevNutrition.includes('high') && veg.nutrition === 'high') {
                    score -= 15;
                    reasons.push('‚ö†Ô∏è High nutrient demand after heavy feeder');
                } else if (veg.nutrition === 'low') {
                    score += 10;
                    reasons.push('Low nutrient demand is soil-friendly');
                }
                
                // Rule 3: Companion planting with current year's plants
                for (const currentVegId of currentYear) {
                    const compatibility = veg.isCompatibleWith(currentVegId);
                    if (compatibility === 1) {
                        score += 15;
                        reasons.push(`Good companion with ${this.garden.vegetables.get(currentVegId).name}`);
                    } else if (compatibility === -1) {
                        score -= 30;
                        reasons.push(`‚ö†Ô∏è Poor companion with ${this.garden.vegetables.get(currentVegId).name}`);
                    }
                }
                
                // Rule 4: Prefer empty beds for flexibility
                if (currentYear.length === 0) {
                    score += 5;
                }
                
                // Rule 5: Two-year rotation check (avoid same veg 2 years ago)
                const twoYearsAgo = this.garden.getPlantingIdsForBed(bedId, year - 2);
                if (twoYearsAgo.includes(vegId)) {
                    score -= 10;
                    reasons.push('‚ö†Ô∏è Same vegetable was grown here 2 years ago');
                }
                
                return { total: score, reasons };
            }
        }
        
        // ============================================
        // APPLICATION CONTROLLER
        // ============================================
        
        const app = {
            garden: new GardenManager(),
            suggestionEngine: null,
            currentYear: 2024,
            wishlist: [],
            
            init() {
                // Try to load saved data
                const loaded = this.garden.loadFromLocalStorage();
                
                // If no saved data, initialize with default beds
                if (!loaded) {
                    for (let i = 0; i < 4; i++) {
                        this.garden.addBed(`Bed ${i + 1}`);
                    }
                }
                
                this.suggestionEngine = new SuggestionEngine(this.garden);
                
                // Populate vegetable select
                const select = document.getElementById('vegetableSelect');
                const sortedVeggies = Array.from(this.garden.vegetables.values())
                    .sort((a, b) => a.name.localeCompare(b.name));
                
                sortedVeggies.forEach(veg => {
                    const option = document.createElement('option');
                    option.value = veg.id;
                    option.textContent = veg.name;
                    select.appendChild(option);
                });
                
                this.render();
            },
            
            changeYear(delta) {
                this.currentYear += delta;
                document.getElementById('yearDisplay').textContent = this.currentYear;
                document.getElementById('yearDisplayBeds').textContent = this.currentYear;
                this.render();
            },
            
            addToWishlist() {
                const select = document.getElementById('vegetableSelect');
                const vegId = select.value;
                if (vegId && !this.wishlist.includes(vegId)) {
                    this.wishlist.push(vegId);
                    select.value = '';
                    this.renderWishlist();
                }
            },
            
            removeFromWishlist(vegId) {
                this.wishlist = this.wishlist.filter(v => v !== vegId);
                this.renderWishlist();
            },
            
            renderWishlist() {
                const container = document.getElementById('wishlistItems');
                if (this.wishlist.length === 0) {
                    container.innerHTML = '<p style="color: var(--soil-medium); font-style: italic;">No vegetables selected yet</p>';
                    return;
                }
                
                container.innerHTML = this.wishlist.map(vegId => {
                    const veg = this.garden.vegetables.get(vegId);
                    if (!veg) return '';
                    return `
                        <div class="wishlist-tag">
                            ${veg.name}
                            <button onclick="app.removeFromWishlist('${vegId}')">√ó</button>
                        </div>
                    `;
                }).join('');
            },
            
            addBed() {
                this.garden.addBed();
                this.save();
                this.render();
            },
            
            removeBed(bedId) {
                if (confirm('Remove this bed and all its planting history?')) {
                    this.garden.removeBed(bedId);
                    this.save();
                    this.render();
                }
            },
            
            openBedModal(bedId) {
                const bed = this.garden.beds.get(bedId);
                if (!bed) return;
                
                const modal = document.getElementById('bedModal');
                const modalBody = document.getElementById('modalBody');
                
                modalBody.innerHTML = `
                    <div class="form-group">
                        <label>Bed Name</label>
                        <input type="text" id="bedNameInput" value="${bed.name}" style="width: 100%;">
                    </div>
                    <div class="form-group">
                        <label>Assign Plants for ${this.currentYear}</label>
                        <select id="plantSelect" style="width: 100%;">
                            <option value="">Select plant...</option>
                            ${Array.from(this.garden.vegetables.values())
                                .sort((a, b) => a.name.localeCompare(b.name))
                                .map(veg => `<option value="${veg.id}">${veg.name}</option>`)
                                .join('')}
                        </select>
                        <button class="btn btn-primary" style="margin-top: 0.5rem;" onclick="app.addPlantToBed(${bedId})">Add Plant</button>
                    </div>
                    <div id="bedPlantsList">
                        ${this.renderBedPlantsList(bedId)}
                    </div>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="app.saveBed(${bedId})">Save</button>
                `;
                
                modal.classList.add('active');
            },
            
            renderBedPlantsList(bedId) {
                const vegIds = this.garden.getPlantingIdsForBed(bedId, this.currentYear);
                
                if (vegIds.length === 0) {
                    return '<p style="color: var(--soil-medium); font-style: italic; margin-top: 1rem;">No plants assigned for this year</p>';
                }
                
                return `
                    <div style="margin-top: 1rem;">
                        <strong>Current Plants (${this.currentYear}):</strong>
                        ${vegIds.map(vegId => {
                            const veg = this.garden.vegetables.get(vegId);
                            if (!veg) return '';
                            return `
                                <div style="background: var(--cream); padding: 0.75rem; margin: 0.5rem 0; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                                    <span>${veg.name} <span style="font-size: 0.8rem; color: var(--soil-medium);">(${veg.family})</span></span>
                                    <button onclick="app.removePlantFromBed(${bedId}, '${vegId}')" style="background: var(--terracotta); color: white; border: none; padding: 0.25rem 0.75rem; border-radius: 4px; cursor: pointer;">Remove</button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },
            
            addPlantToBed(bedId) {
                const select = document.getElementById('plantSelect');
                const vegId = select.value;
                if (!vegId) return;
                
                this.garden.addPlanting(bedId, this.currentYear, vegId);
                select.value = '';
                
                const modalBody = document.getElementById('modalBody');
                modalBody.querySelector('#bedPlantsList').innerHTML = this.renderBedPlantsList(bedId);
                
                this.save();
            },
            
            removePlantFromBed(bedId, vegId) {
                this.garden.removePlanting(bedId, this.currentYear, vegId);
                
                const modalBody = document.getElementById('modalBody');
                modalBody.querySelector('#bedPlantsList').innerHTML = this.renderBedPlantsList(bedId);
                
                this.save();
            },
            
            saveBed(bedId) {
                const bed = this.garden.beds.get(bedId);
                const nameInput = document.getElementById('bedNameInput');
                bed.name = nameInput.value;
                this.closeModal();
                this.save();
                this.render();
            },
            
            closeModal() {
                document.getElementById('bedModal').classList.remove('active');
            },
            
            generateSuggestions() {
                if (this.wishlist.length === 0) {
                    alert('Please add vegetables to your wishlist first!');
                    return;
                }
                
                const suggestions = this.suggestionEngine.generateSuggestions(this.wishlist, this.currentYear);
                this.renderSuggestions(suggestions);
            },
            
            renderSuggestions(suggestions) {
                const container = document.getElementById('suggestionsBox');
                
                if (suggestions.length === 0) {
                    container.innerHTML = `
                        <div class="suggestion-box">
                            <h4>No Suggestions Available</h4>
                            <p>Unable to place all vegetables. Try adding more beds or adjusting your wishlist.</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <div class="suggestion-box">
                        <h4>üåü Suggested Garden Plan</h4>
                        ${suggestions.map(s => `
                            <div class="suggestion-item">
                                <strong>${s.bedName}:</strong> ${s.vegetableName}<br>
                                <small style="color: var(--soil-medium); display: block; margin: 0.5rem 0;">
                                    ${s.reasons.slice(0, 2).join(' ‚Ä¢ ')}
                                </small>
                                <button class="btn btn-primary" style="margin-top: 0.5rem; padding: 0.5rem 1rem; font-size: 0.85rem;" 
                                        onclick="app.applySuggestion(${s.bedId}, '${s.vegId}')">
                                    Apply to Bed
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
            },
            
            applySuggestion(bedId, vegId) {
                this.garden.addPlanting(bedId, this.currentYear, vegId);
                this.save();
                this.render();
            },
            
            showCompatibilityMatrix() {
                const modal = document.getElementById('matrixModal');
                const body = document.getElementById('matrixBody');
                
                const veggies = Array.from(this.garden.vegetables.values())
                    .sort((a, b) => a.name.localeCompare(b.name));
                
                let html = `
                    <div class="compatibility-matrix">
                        <table class="compatibility-table">
                            <thead>
                                <tr>
                                    <th>Plant</th>
                                    ${veggies.map(v => `<th>${v.name}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                veggies.forEach(rowVeg => {
                    html += `<tr><th>${rowVeg.name}</th>`;
                    veggies.forEach(colVeg => {
                        if (rowVeg.id === colVeg.id) {
                            html += '<td class="compat-neutral">-</td>';
                        } else {
                            const compat = rowVeg.isCompatibleWith(colVeg.id);
                            if (compat === 1) {
                                html += '<td class="compat-good">‚úì</td>';
                            } else if (compat === -1) {
                                html += '<td class="compat-bad">‚úó</td>';
                            } else {
                                html += '<td class="compat-neutral">‚óã</td>';
                            }
                        }
                    });
                    html += '</tr>';
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 1rem; font-size: 0.9rem;">
                        <strong>Legend:</strong> ‚úì = Good companions | ‚úó = Bad companions | ‚óã = Neutral
                    </div>
                `;
                
                body.innerHTML = html;
                modal.classList.add('active');
            },
            
            closeMatrixModal() {
                document.getElementById('matrixModal').classList.remove('active');
            },
            
            exportData() {
                const data = this.garden.exportData();
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `garden-plan-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },
            
            importData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const success = this.garden.importData(event.target.result);
                        if (success) {
                            alert('Data imported successfully!');
                            this.save();
                            this.render();
                        } else {
                            alert('Failed to import data. Please check the file format.');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            },
            
            save() {
                this.garden.saveToLocalStorage();
            },
            
            render() {
                const grid = document.getElementById('gardenGrid');
                const beds = Array.from(this.garden.beds.values());
                
                if (beds.length === 0) {
                    grid.innerHTML = '<p class="empty-bed">No beds yet. Add one to get started!</p>';
                    return;
                }
                
                grid.innerHTML = beds.map(bed => {
                    const currentPlantings = this.garden.getPlantingsForBed(bed.id, this.currentYear);
                    const prevPlantings = this.garden.getPlantingsForBed(bed.id, this.currentYear - 1);
                    
                    let content = '';
                    if (currentPlantings.length === 0) {
                        content = `<div class="empty-bed">Click to assign plants</div>`;
                    } else {
                        content = currentPlantings.map(veg => {
                            const currentIds = currentPlantings.map(v => v.id);
                            const goodCompanions = currentIds.filter(id => id !== veg.id && veg.isCompatibleWith(id) === 1);
                            const badCompanions = currentIds.filter(id => id !== veg.id && veg.isCompatibleWith(id) === -1);
                            
                            return `
                                <div class="plant-assignment">
                                    <div class="plant-name">${veg.name}</div>
                                    <div class="plant-meta">
                                        <span class="nutrition-badge nutrition-${veg.nutrition}">
                                            ${veg.nutrition} nutrition
                                        </span>
                                        <span>${veg.family}</span>
                                    </div>
                                    ${goodCompanions.length > 0 ? `
                                        <div class="companions-list">
                                            ${goodCompanions.map(id => {
                                                const c = this.garden.vegetables.get(id);
                                                return c ? `<span class="companion-tag companion-good">‚úì ${c.name}</span>` : '';
                                            }).join('')}
                                        </div>
                                    ` : ''}
                                    ${badCompanions.length > 0 ? `
                                        <div class="companions-list">
                                            ${badCompanions.map(id => {
                                                const c = this.garden.vegetables.get(id);
                                                return c ? `<span class="companion-tag companion-bad">‚úó ${c.name}</span>` : '';
                                            }).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('');
                    }
                    
                    let prevYearInfo = '';
                    if (prevPlantings.length > 0) {
                        prevYearInfo = `
                            <div style="font-size: 0.8rem; color: var(--soil-medium); margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--sage);">
                                Previous (${this.currentYear - 1}): ${prevPlantings.map(v => v.name).join(', ')}
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="bed" onclick="app.openBedModal(${bed.id})">
                            <div class="bed-header">
                                <div class="bed-name">${bed.name}</div>
                                <div class="bed-actions">
                                    <button onclick="event.stopPropagation(); app.removeBed(${bed.id})" title="Remove bed">üóëÔ∏è</button>
                                </div>
                            </div>
                            <div class="bed-content">
                                ${content}
                                ${prevYearInfo}
                            </div>
                        </div>
                    `;
                }).join('');
                
                this.renderWishlist();
            }
        };
        
        // Initialize app
        app.init();
    </script>
</body>
</html>